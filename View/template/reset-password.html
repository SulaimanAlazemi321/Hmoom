<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hmoom - Reset Password</title>
        <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon.png">
    <link rel="shortcut icon" href="/static/images/favicon.png">
    <link rel="apple-touch-icon" href="/static/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 min-h-screen">

<div class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md">
    
    <!-- Reset Password Card -->
    <div class="bg-gray-800/50 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-700/50 p-8">
      
      <!-- Header -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-primary-600 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3a1 1 0 011-1h2.586l6.414-6.414A6 6 0 0121 9z"></path>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-white mb-2">Reset Your Password</h1>
        <p class="text-gray-400">Create a new secure password for:</p>
        <p id="emailDisplay" class="text-primary-400 font-medium"></p>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="text-center py-8">
        <svg class="w-8 h-8 animate-spin mx-auto mb-4 text-primary-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-400">Validating reset token...</p>
      </div>

      <!-- Reset Password Form -->
      <form id="resetPasswordForm" class="space-y-6 hidden">
        
        <!-- New Password Field -->
        <div class="space-y-2">
          <label for="newPassword" class="block text-sm font-medium text-gray-300">
            New Password *
          </label>
          <div class="relative">
            <input type="password" 
                   id="newPassword" 
                   name="newPassword"
                   required
                   minlength="8"
                   class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-xl text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200"
                   placeholder="Enter new password">
            <button type="button" 
                    id="toggleNewPassword"
                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-300 focus:outline-none">
              <svg id="eyeIconNew" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
          
          <!-- Password Requirements Checklist -->
          <div id="passwordRequirements" class="text-xs space-y-1 mt-2">
            <div class="text-gray-400 font-medium mb-1">Password must contain:</div>
            <div id="req-length" class="flex items-center space-x-2">
              <span class="w-4 h-4 rounded-full border border-gray-500 flex items-center justify-center">
                <svg class="w-3 h-3 text-green-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </span>
              <span class="text-gray-500">At least 8 characters</span>
            </div>
            <div id="req-uppercase" class="flex items-center space-x-2">
              <span class="w-4 h-4 rounded-full border border-gray-500 flex items-center justify-center">
                <svg class="w-3 h-3 text-green-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </span>
              <span class="text-gray-500">One uppercase letter (A-Z)</span>
            </div>
            <div id="req-symbol" class="flex items-center space-x-2">
              <span class="w-4 h-4 rounded-full border border-gray-500 flex items-center justify-center">
                <svg class="w-3 h-3 text-green-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </span>
              <span class="text-gray-500">One special character (!@#$%^&*)</span>
            </div>
          </div>
        </div>

        <!-- Confirm Password Field -->
        <div class="space-y-2">
          <label for="confirmPassword" class="block text-sm font-medium text-gray-300">
            Confirm New Password *
          </label>
          <div class="relative">
            <input type="password" 
                   id="confirmPassword" 
                   name="confirmPassword"
                   required
                   class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-xl text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200"
                   placeholder="Confirm new password">
            <button type="button" 
                    id="toggleConfirmPassword"
                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-300 focus:outline-none">
              <svg id="eyeIconConfirm" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Reset Password Button -->
        <button type="submit" 
                id="resetPasswordBtn"
                class="w-full px-6 py-3 text-lg font-semibold text-white bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>Reset Password</span>
        </button>

      </form>

      <!-- Error State -->
      <div id="errorState" class="text-center py-8 hidden">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-white mb-2">Invalid Reset Link</h3>
        <p class="text-gray-400 mb-6">This password reset link is invalid or has expired.</p>
        <a href="/forgot-password" 
           class="inline-flex items-center px-6 py-3 text-sm font-medium text-primary-400 hover:text-primary-300 bg-primary-500/10 hover:bg-primary-500/20 border border-primary-500/30 hover:border-primary-500/50 rounded-xl transition-all duration-200 space-x-2">
          <span>Request New Reset Link</span>
        </a>
      </div>

      <!-- Footer -->
      <div class="mt-8 text-center">
        <a href="/login" 
           class="text-sm text-gray-500 hover:text-gray-400 underline transition-colors duration-200">
          ← Back to Login
        </a>
      </div>

    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
  <!-- Toasts will be inserted here -->
</div>

<script>
const loadingState = document.getElementById('loadingState');
const resetPasswordForm = document.getElementById('resetPasswordForm');
const errorState = document.getElementById('errorState');
const emailDisplay = document.getElementById('emailDisplay');
const newPasswordInput = document.getElementById('newPassword');
const confirmPasswordInput = document.getElementById('confirmPassword');
const resetPasswordBtn = document.getElementById('resetPasswordBtn');

// Get token from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const resetToken = urlParams.get('token');

if (!resetToken) {
  showErrorState('No reset token provided');
} else {
  validateToken();
}

// Password validation functions (same as signup)
function validatePasswordRequirements(password) {
  const requirements = {
    length: password.length >= 8,
    uppercase: /[A-Z]/.test(password),
    symbol: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)
  };
  return requirements;
}

function updatePasswordUI(password) {
  const requirements = validatePasswordRequirements(password);
  
  Object.keys(requirements).forEach(req => {
    const element = document.getElementById(`req-${req}`);
    const icon = element.querySelector('svg');
    const text = element.querySelector('span:last-child');
    
    if (requirements[req]) {
      icon.classList.remove('hidden');
      text.classList.remove('text-gray-500');
      text.classList.add('text-green-500');
      element.querySelector('.w-4').classList.remove('border-gray-500');
      element.querySelector('.w-4').classList.add('border-green-500', 'bg-green-500');
    } else {
      icon.classList.add('hidden');
      text.classList.remove('text-green-500');
      text.classList.add('text-gray-500');
      element.querySelector('.w-4').classList.remove('border-green-500', 'bg-green-500');
      element.querySelector('.w-4').classList.add('border-gray-500');
    }
  });
}

// Validate token with backend
async function validateToken() {
  try {
    const response = await fetch(`/user/reset-password/validate-token?token=${resetToken}`);
    const result = await response.json();

    if (response.ok && result.valid) {
      emailDisplay.textContent = result.email;
      showForm();
    } else {
      showErrorState(result.detail || 'Invalid or expired reset token');
    }
  } catch (error) {
    showErrorState('Network error. Please check your connection.');
  }
}

function showForm() {
  loadingState.classList.add('hidden');
  resetPasswordForm.classList.remove('hidden');
  newPasswordInput.focus();
}

function showErrorState(message) {
  loadingState.classList.add('hidden');
  errorState.classList.remove('hidden');
  if (message) {
    errorState.querySelector('p').textContent = message;
  }
}

// Password visibility toggles
document.getElementById('toggleNewPassword').addEventListener('click', () => {
  const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
  newPasswordInput.setAttribute('type', type);
  
  const eyeIcon = document.getElementById('eyeIconNew');
  if (type === 'text') {
    eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a10.05 10.05 0 012.042-3.592m3.363-2.547A9.969 9.969 0 0112 5c4.477 0 8.268 2.943 9.542 7a9.972 9.972 0 01-4.132 5.411M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>`;
  } else {
    eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>`;
  }
});

document.getElementById('toggleConfirmPassword').addEventListener('click', () => {
  const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
  confirmPasswordInput.setAttribute('type', type);
  
  const eyeIcon = document.getElementById('eyeIconConfirm');
  if (type === 'text') {
    eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a10.05 10.05 0 012.042-3.592m3.363-2.547A9.969 9.969 0 0112 5c4.477 0 8.268 2.943 9.542 7a9.972 9.972 0 01-4.132 5.411M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>`;
  } else {
    eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>`;
  }
});

// Password validation
function validatePasswords() {
  const password = newPasswordInput.value;
  const confirmPassword = confirmPasswordInput.value;
  
  if (password !== confirmPassword && confirmPassword !== '') {
    confirmPasswordInput.setCustomValidity("Passwords don't match");
    confirmPasswordInput.classList.add('border-red-500');
    confirmPasswordInput.classList.remove('border-gray-700');
  } else {
    confirmPasswordInput.setCustomValidity("");
    confirmPasswordInput.classList.remove('border-red-500');
    confirmPasswordInput.classList.add('border-gray-700');
  }
}

newPasswordInput.addEventListener('input', (e) => {
  updatePasswordUI(e.target.value);
  validatePasswords();
});

confirmPasswordInput.addEventListener('input', validatePasswords);

// Form submission
resetPasswordForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const newPassword = newPasswordInput.value;
  const confirmPassword = confirmPasswordInput.value;
  
  // Validate password complexity
  const requirements = validatePasswordRequirements(newPassword);
  if (!requirements.length || !requirements.uppercase || !requirements.symbol) {
    showToast('Please ensure your password meets all requirements', 'error');
    return;
  }
  
  // Validate passwords match
  if (newPassword !== confirmPassword) {
    showToast('Passwords do not match!', 'error');
    return;
  }
  
  resetPasswordBtn.disabled = true;
  resetPasswordBtn.innerHTML = `
    <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    Resetting Password...
  `;

  try {
    const response = await fetch('/user/reset-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        token: resetToken,
        new_password: newPassword,
        confirm_password: confirmPassword
      })
    });

    const result = await response.json();

    if (response.ok) {
      showToast('✅ Password reset successfully! Redirecting to login...', 'success');
      
      // Show success state
      resetPasswordForm.innerHTML = `
        <div class="text-center py-8">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-green-500 rounded-full mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">Password Reset Complete!</h3>
          <p class="text-gray-400 mb-6">You can now log in with your new password.</p>
          <a href="/login" class="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-xl transition-all duration-200 space-x-2">
            <span>Go to Login</span>
          </a>
        </div>
      `;
      
      // Auto-redirect after 3 seconds
      setTimeout(() => {
        window.location.href = '/login';
      }, 3000);
      
    } else {
      showToast(result.detail || 'Failed to reset password', 'error');
    }
  } catch (error) {
    showToast('Network error. Please try again.', 'error');
  } finally {
    resetPasswordBtn.disabled = false;
    resetPasswordBtn.innerHTML = `
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>Reset Password</span>
    `;
  }
});

// Enhanced Toast function
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  
  let bgColor, icon;
  switch(type) {
    case 'success':
      bgColor = 'bg-green-500';
      icon = '✅';
      break;
    case 'error':
      bgColor = 'bg-red-500';
      icon = '❌';
      break;
    case 'warning':
      bgColor = 'bg-yellow-500';
      icon = '⚠️';
      break;
    default:
      bgColor = 'bg-blue-500';
      icon = 'ℹ️';
  }
  
  toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-500 translate-x-full opacity-0 flex items-center space-x-2 min-w-[300px]`;
  toast.innerHTML = `
    <span class="text-xl">${icon}</span>
    <span class="flex-1">${message}</span>
    <button onclick="this.parentElement.remove()" class="text-white/80 hover:text-white text-xl leading-none">&times;</button>
  `;
  
  document.getElementById('toast-container').appendChild(toast);
  
  setTimeout(() => {
    toast.classList.remove('translate-x-full', 'opacity-0');
  }, 100);
  
  setTimeout(() => {
    if (toast.parentElement) {
      toast.classList.add('translate-x-full', 'opacity-0');
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 500);
    }
  }, 4000);
}
</script>

</body>
</html> 